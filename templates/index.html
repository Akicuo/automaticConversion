{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding-top: 2rem;">

    <!-- Request Section (Visible to all) -->
    <div style="margin-bottom: 3rem;">
        <h2 style="font-weight: 400; font-size: 1.2rem; margin-bottom: 1rem; color: var(--text-secondary);">
            {% if role == 'admin' %}Start Conversion{% else %}Request Conversion{% endif %}
        </h2>
        <div class="glass-panel" style="padding: 0.5rem; display: flex; align-items: center; position: relative;">
            <input type="text" id="modelSearch" placeholder="Search HuggingFace models..." autocomplete="off"
                style="flex-grow: 1; border: none; background: transparent; padding: 1rem; font-size: 1rem; color: var(--text-primary); outline: none;">
            {% if role == 'admin' %}
            <button class="primary" onclick="convertModel()" style="margin: 0.5rem;">Start</button>
            {% else %}
            <button class="primary" onclick="requestModel()" style="margin: 0.5rem;">Request</button>
            {% endif %}

            <div id="suggestions" class="glass-panel"
                style="position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; display: none; margin-top: 0.25rem; background: #050505; z-index: 20;">
            </div>
        </div>
        {% if role == 'admin' %}
        <div style="margin-top: 1rem;">
            <label
                style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                <input type="checkbox" id="validationCheck" checked style="accent-color: var(--text-primary);">
                Validate disk space
            </label>
        </div>
        {% endif %}
    </div>

    <!-- Admin: Pending Requests -->
    {% if role == 'admin' %}
    <div style="margin-bottom: 3rem;">
        <h2 style="font-weight: 400; font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--text-secondary);">Pending
            Requests</h2>
        <div id="requests-list" style="display: grid; gap: 0.75rem;">
            <div
                style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">
                Loading...</div>
        </div>
    </div>
    {% endif %}

    <!-- My Requests (Visible to logged-in users) -->
    {% if user and role != 'admin' %}
    <div style="margin-bottom: 3rem;">
        <h2 style="font-weight: 400; font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--text-secondary);">My
            Requests</h2>
        <div id="my-requests-list" style="display: grid; gap: 0.75rem;">
            <div
                style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">
                Loading...</div>
        </div>
    </div>
    {% endif %}

    <!-- Status Board -->
    <div>
        <h2 style="font-weight: 400; font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--text-secondary);">Conversion
            Queue</h2>
        <div id="models-list" style="display: grid; gap: 1rem;">
            <div
                style="text-align: center; color: var(--text-secondary); padding: 2rem; border: 1px dashed var(--glass-border); border-radius: 8px;">
                No active conversions.</div>
        </div>
    </div>
</div>

<template id="model-card-template">
    <div class="model-card glass-panel" data-model-id="" style="padding: 1.5rem; transition: border-color 0.2s;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 class="model-name" style="margin: 0; font-size: 1rem; font-weight: 500;">Model Name</h3>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span class="status-badge"
                    style="font-family: monospace; letter-spacing: 0.05em; font-size: 0.75rem;">Status</span>
                <button class="delete-btn"
                    style="display: none; background: transparent; color: var(--error); border: 1px solid var(--error); padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">Delete</button>
            </div>
        </div>
        <div class="progress-bar-bg"
            style="background: rgba(255,255,255,0.05); height: 2px; width: 100%; margin-bottom: 1rem;">
            <div class="progress-bar-fill"
                style="background: var(--text-primary); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
        </div>
        <div class="logs"
            style="font-family: 'Consolas', 'Monaco', monospace; font-size: 0.75rem; color: #a0e0a0; background: #0a0a0a; padding: 1rem; border-radius: 6px; height: 200px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5;">
        </div>
        <div class="error-section"
            style="display: none; margin-top: 1rem; padding: 0.75rem; background: rgba(255,68,68,0.1); border-radius: 4px; font-size: 0.8rem; color: var(--error);">
        </div>
    </div>
</template>

<template id="request-card-template">
    <div class="request-card glass-panel" style="padding: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div>
                <span class="request-model" style="font-weight: 500;"></span>
                <span class="request-by"
                    style="color: var(--text-secondary); font-size: 0.85rem; margin-left: 0.5rem;"></span>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="approve-btn"
                    style="background: var(--success); color: #000; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Approve</button>
                <button class="reject-btn"
                    style="background: transparent; color: var(--error); border: 1px solid var(--error); padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Reject</button>
            </div>
        </div>
        <div class="decline-reason-row" style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" class="decline-reason-input" placeholder="Decline reason (optional)..."
                style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 0.5rem; border-radius: 4px; color: var(--text-primary); font-size: 0.85rem;">
        </div>
    </div>
</template>

<template id="my-request-card-template">
    <div class="my-request-card glass-panel" style="padding: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="request-model" style="font-weight: 500;"></span>
            <span class="request-status" style="font-family: monospace; font-size: 0.75rem;"></span>
        </div>
        <div class="decline-reason"
            style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: rgba(255,68,68,0.1); border-radius: 4px; font-size: 0.85rem; color: var(--error);">
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('modelSearch');
    const suggestionsBox = document.getElementById('suggestions');
    const isAdmin = '{{ role }}' === 'admin';

    // Autocomplete
    if (searchInput) {
        let debounceTimer;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value;
            if (query.length < 3) {
                suggestionsBox.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(() => fetchSuggestions(query), 300);
        });
    }

    async function fetchSuggestions(query) {
        try {
            const res = await fetch(`/api/hf/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            suggestionsBox.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(model => {
                    const div = document.createElement('div');
                    div.textContent = model.id;
                    div.style.padding = '1rem';
                    div.style.cursor = 'pointer';
                    div.style.transition = 'background 0.2s';
                    div.onmouseover = () => div.style.background = 'rgba(255,255,255,0.05)';
                    div.onmouseout = () => div.style.background = 'transparent';
                    div.onclick = () => {
                        searchInput.value = model.id;
                        suggestionsBox.style.display = 'none';
                    };
                    suggestionsBox.appendChild(div);
                });
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function convertModel() {
        const modelId = searchInput.value;
        if (!modelId) return;

        try {
            const res = await fetch('/api/models/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_id: modelId })
            });
            if (res.ok) {
                searchInput.value = '';
                fetchStatus();
            } else {
                const err = await res.json();
                alert('Error: ' + err.detail);
            }
        } catch (e) {
            alert('Failed to start process');
        }
    }

    async function requestModel() {
        const modelId = searchInput.value;
        if (!modelId) return;

        try {
            const res = await fetch('/api/requests/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hf_repo_id: modelId })
            });
            const data = await res.json();
            alert(data.message);
            searchInput.value = '';
        } catch (e) {
            alert('Failed to submit request');
        }
    }

    async function fetchStatus() {
        try {
            const res = await fetch('/api/status/all');
            const models = await res.json();
            renderModels(models);
        } catch (e) { console.error(e); }
    }

    // Store scroll positions for each model's log panel
    const logScrollPositions = {};

    // Track if user is actively scrolling (to avoid auto-scroll to bottom)
    const userScrolling = {};

    function renderModels(models) {
        const container = document.getElementById('models-list');
        const template = document.getElementById('model-card-template');

        // Save current scroll positions before update
        container.querySelectorAll('.model-card').forEach(card => {
            const modelId = card.dataset.modelId;
            const logs = card.querySelector('.logs');
            if (modelId && logs) {
                // Check if user has scrolled up (not at bottom)
                const isAtBottom = logs.scrollHeight - logs.scrollTop <= logs.clientHeight + 50;
                logScrollPositions[modelId] = {
                    scrollTop: logs.scrollTop,
                    wasAtBottom: isAtBottom
                };
            }
        });

        container.innerHTML = '';

        if (models.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem; border: 1px dashed var(--glass-border); border-radius: 8px;">No active conversions.</div>';
            return;
        }

        models.forEach(model => {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.model-card');

            // Set model ID for tracking
            card.dataset.modelId = model.id;

            clone.querySelector('.model-name').textContent = model.hf_repo_id;

            const badge = clone.querySelector('.status-badge');
            badge.textContent = model.status.toUpperCase();

            if (model.status === 'error') {
                badge.style.color = 'var(--error)';
            } else if (model.status === 'complete') {
                badge.style.color = 'var(--success)';
            }

            clone.querySelector('.progress-bar-fill').style.width = `${model.progress}%`;

            const logs = clone.querySelector('.logs');
            logs.textContent = model.log;

            // Restore scroll position or scroll to bottom for new content
            const savedPos = logScrollPositions[model.id];
            if (savedPos) {
                if (savedPos.wasAtBottom) {
                    // User was at bottom, keep them there (auto-scroll)
                    logs.scrollTop = logs.scrollHeight;
                } else {
                    // User had scrolled up, preserve their position
                    logs.scrollTop = savedPos.scrollTop;
                }
            } else {
                // New model, scroll to bottom
                logs.scrollTop = logs.scrollHeight;
            }

            // Show error details if present
            if (model.error_details) {
                const errorSection = clone.querySelector('.error-section');
                errorSection.style.display = 'block';
                errorSection.textContent = model.error_details.slice(0, 500);
            }

            // Show delete button for admin on error or complete status
            if (isAdmin && (model.status === 'error' || model.status === 'complete')) {
                const deleteBtn = clone.querySelector('.delete-btn');
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = () => deleteModel(model.id, model.hf_repo_id);
            }

            container.appendChild(clone);
        });
    }

    async function deleteModel(modelId, modelName) {
        if (!confirm(`Delete job for "${modelName}"?`)) return;

        try {
            const res = await fetch(`/api/models/${modelId}`, { method: 'DELETE' });
            if (res.ok) {
                fetchStatus();
            } else {
                const err = await res.json();
                alert('Failed to delete: ' + err.detail);
            }
        } catch (e) {
            alert('Failed to delete model');
        }
    }

    // Requests (Admin only)
    async function fetchRequests() {
        if (!isAdmin) return;
        const container = document.getElementById('requests-list');
        if (!container) return;

        try {
            const res = await fetch('/api/requests/all');
            if (!res.ok) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">No pending requests.</div>';
                return;
            }
            const requests = await res.json();
            renderRequests(requests.filter(r => r.status === 'pending'));
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">No pending requests.</div>';
        }
    }

    function renderRequests(requests) {
        const container = document.getElementById('requests-list');
        if (!container) return;

        const template = document.getElementById('request-card-template');

        container.innerHTML = '';

        if (requests.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">No pending requests.</div>';
            return;
        }

        requests.forEach(req => {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.request-card');

            clone.querySelector('.request-model').textContent = req.hf_repo_id;
            clone.querySelector('.request-by').textContent = `by ${req.requested_by}`;

            const declineInput = clone.querySelector('.decline-reason-input');

            clone.querySelector('.approve-btn').onclick = async () => {
                await fetch(`/api/requests/${req.id}/approve`, { method: 'POST' });
                fetchRequests();
                fetchStatus();
            };

            clone.querySelector('.reject-btn').onclick = async () => {
                const reason = declineInput ? declineInput.value : '';
                await fetch(`/api/requests/${req.id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason })
                });
                fetchRequests();
            };

            container.appendChild(clone);
        });
    }

    // My Requests (For logged-in users)
    const isLoggedIn = '{{ user }}' !== 'None' && '{{ user }}' !== '';

    async function fetchMyRequests() {
        if (isAdmin || !isLoggedIn) return;
        const container = document.getElementById('my-requests-list');
        if (!container) return;

        try {
            const res = await fetch('/api/requests/my');
            if (!res.ok) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">No requests yet.</div>';
                return;
            }
            const requests = await res.json();
            renderMyRequests(requests);
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">No requests yet.</div>';
        }
    }

    function renderMyRequests(requests) {
        const container = document.getElementById('my-requests-list');
        if (!container) return;

        const template = document.getElementById('my-request-card-template');

        container.innerHTML = '';

        if (requests.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1.5rem; border: 1px dashed var(--glass-border); border-radius: 8px; font-size: 0.9rem;">No requests yet.</div>';
            return;
        }

        requests.forEach(req => {
            const clone = template.content.cloneNode(true);

            clone.querySelector('.request-model').textContent = req.hf_repo_id;

            const statusBadge = clone.querySelector('.request-status');
            statusBadge.textContent = req.status.toUpperCase();

            if (req.status === 'approved') {
                statusBadge.style.color = 'var(--success)';
            } else if (req.status === 'rejected') {
                statusBadge.style.color = 'var(--error)';
            } else {
                statusBadge.style.color = 'var(--text-secondary)';
            }

            // Show decline reason if rejected
            if (req.status === 'rejected' && req.decline_reason) {
                const declineDiv = clone.querySelector('.decline-reason');
                declineDiv.style.display = 'block';
                declineDiv.innerHTML = '<strong>Reason:</strong> ' + req.decline_reason;
            }

            container.appendChild(clone);
        });
    }

    setInterval(fetchStatus, 2000);
    setInterval(fetchRequests, 5000);
    setInterval(fetchMyRequests, 5000);
    fetchStatus();
    fetchRequests();
    fetchMyRequests();
</script>
{% endblock %}